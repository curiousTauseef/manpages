<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8"/>
		<title>System Call</title>
		<link rel="stylesheet" href="css/book.css" type="text/css"/>
	</head>
	<body>
		<h2>
			System Call
		</h2>
		<p>
			A <span class="term">system call</span> differs from a <span class="term">user-land function</span> in that it triggers
			the operating system kernel to perform some operation.  This usually applies to I/O, such as reading from files or
			sockets with <span class="func">write</span>.
		</p>
		<p>
			In <span class="lang">mdoc</span>, A system call is a special function consisting of at least one section not found in
			ordinary function manuals.
		</p>
		<p>
			The first difference between ordinary functions and system calls is the manual category.  Let's study a function <span
				class="func">khello</span>, <span class="screen">kernel hello</span>, which is similar to the <span
				class="func">hello</span> function described earlier.
		</p>
		<pre>
.Dd May 30, 2011
.Dt KHELLO 2
.Os
		</pre>
		<p>
			All system calls are in category two.
		</p>
		<p>
			Unless under special circumstances, system call manuals are each accorded their own manual.
		</p>
		<p>
			I'll use the same descriptive text as in the <span class="func">hello</span> example.  Note that for system calls, the
			<span class="header">hello.h</span> header file should be in the compiler's standard include path.  This is usually
			<span class="path">/usr/include</span> on UNIX systems.
		</p>
		<pre>
.Sh NAME
.Nm hello
.Nd print greeting messages
.Sh SYNOPSIS
.In hello.h
.Ft int
.Fo hello
.Fa "int C" "const char *prefix"
.Fc
.Sh DESCRIPTION
The
.Nm
function prints out a greeting message.
.Pp
It accepts a value
.Fa C ,
which if non-zero indicates output should be uppercase; and
.Fa prefix ,
which, if not
.Dv NULL ,
shall be prefixed to the output.
The
.Fa prefix
argument, if not
.Dv NULL ,
must be nil-terminated.
		</pre>
		<p>
			You'll notice I've omitted the <span class="sec">LIBRARY</span> section in this example, as system calls by definition
			aren't a part of a library.  Furthermore, I've used the <span class="macro">Dv</span> macro to annotate the term <span
				class="screen">NULL</span> as a constant variable.
		</p>
		<p>
			Let's examine the output so far.
		</p>
		<div class="mdocout">
			<div class="mdoc-section">
				<h1>NAME</h1>
				<b class="mdoc-name">hello</b> &#8212; <span class="mdoc-desc">print greeting messages</span>
			</div>
			<div class="mdoc-section">
				<h1>SYNOPSIS</h1>
				<b class="mdoc-includes">#include &lt;<a class="mdoc-link-includes">hello.h</a>&gt;</b>
				<p/>
				<i class="mdoc-ftype">int</i>
				<br/>
				<b class="mdoc-fname">hello</b>(<i class="mdoc-farg">int C</i>, <i class="mdoc-farg">const char *prefix</i>);
			</div>
			<div class="mdoc-section">
				<h1>DESCRIPTION</h1>
				The <b class="mdoc-name">hello</b> function prints out a greeting message.
				<p/>
				It accepts a value <i class="mdoc-farg">C</i>, which if non-zero indicates output should be uppercase; and <i
					class="mdoc-farg">prefix</i>, which, if not <span class="mdoc-define">NULL</span>, shall be prefixed to the
				output. The <i class="mdoc-farg">prefix</i> argument, if not <span class="mdoc-define">NULL</span>, must be
				nil-terminated.
			</div> 
		</div>
		<p>
			In the <span class="func">hello</span> example, I included a section <span class="sec">RETURN VALUES</span> detailing
			the return value of the function.  System calls, however, usually return a standard value and have a side effect of
			setting the C library <span class="var">errno</span> variable when invoked within a C language context.  This is
			documented with a special macro <span class="macro">Rv</span>.
		</p>
		<pre>
.Sh RETURN VALUES
.Rv -std
		</pre>
		<p>
			The <span class="macroflag">std</span> flag is by convention always specified.  This macro will produce standard text
			regarding the <span class="var">errno</span> value and that the function returns <span class="value">-1</span> on
			failure and <span class="value">0</span> on success.
		</p>
		<p>
			If you have multiple functions specified in your manual, you must list them individually as arguments to <span
				class="macro">Rv</span>.
		</p>
		<p>
			Next, the possible values of <span class="var">errno</span> must be specified in the <span class="sec">ERRORS</span>
			section as a list.  Let's assume that <span class="var">EFAULT</span> may be set if the pointer is invalid.
		</p>
		<pre>
.Sh ERRORS
.Bl -tag -width Er
.It Er EFAULT
.Fa prefix
points outside the allocated address space.
.El
		</pre>
		<p>
			The syntax of this list differs from lists we've already encountered.
			Earlier we used the special term <span class="screen">Ds</span> as an argument to
			<span class="macroflag">width</span> to specify a generic width.  Here, we used <span class="macro">Er</span>, which is
			also specified at the start of each list tag (lines beginning with <span class="macro">It</span>).
		</p>
		<p>
			The macro <span class="macro">Er</span> specifies a possible value of <span class="var">errno</span>.  There are many
			standard variable names for <span class="var">errno</span> values, such as <span class="var">EFAULT</span> used in our
			example.  When we stipulate this as the argument of <span class="macroflag">width</span>, the formatter is able to
			translate this into a generic width of most <span class="macro">Er</span> macro contents.
		</p>
		<p>
			You should avoid using this construct unless it's in a conventional way, as it is here.
		</p>
		<p>
			If your system call is part of an operating system, it's common to add some lines as to when it was added.  Let's assume
			you're adding the function to a fictional Foo OS.  Most modern UNIX operating systems have their own macros, such as
			<span class="macro">Bx</span> for BSD UNIX.  Be sure to note the version of the operating system.
		</p>
		<pre>
.Sh HISTORY
The
.Nm
function call appeared in Foo OS version 1.0.
		</pre>
		<p>
			Let's put all of these sections together and preview the output.
		</p>
		<div class="mdocout">
			<div class="mdoc-section">
				<h1>NAME</h1>
				<b class="mdoc-name">hello</b> &#8212; <span class="mdoc-desc">print greeting messages</span>
			</div>
			<div class="mdoc-section">
				<h1>SYNOPSIS</h1>
				<b class="mdoc-includes">#include &lt;<a class="mdoc-link-includes">hello.h</a>&gt;</b>
				<p/>
				<i class="mdoc-ftype">int</i><br/>
				<b class="mdoc-fname">hello</b>(<i class="mdoc-farg">int C</i>, <i class="mdoc-farg">const char *prefix</i>);
			</div>
			<div class="mdoc-section">
				<h1>DESCRIPTION</h1>
				The <b class="mdoc-name">hello</b> function prints out a greeting message.
				<p/>
				It accepts a value <i class="mdoc-farg">C</i>, which if non-zero indicates output should be uppercase; and <i
					class="mdoc-farg">prefix</i>, which, if not <span class="mdoc-define">NULL</span>, shall be prefixed to
				the output. The <i class="mdoc-farg">prefix</i> argument, if not <span class="mdoc-define">NULL</span>, must be
				nil-terminated.
			</div> 
			<div class="mdoc-section">
				<h1>RETURN VALUES</h1>
				The <b class="mdoc-fname">hello</b>() function returns the value 0 if successful; otherwise the value -1 is
				returned and the global variable <b class="mdoc-var">errno</b> is set to indicate the error.
			</div>
			<div class="mdoc-section">
				<h1>ERRORS</h1>
				<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="mdoc-list list-tag">
					<dt class="mdoc-list-tag" style="margin-top: 1.00em;">
						<span class="mdoc-errno">EFAULT</span></dt>
					<dd class="mdoc-list-tag" style="margin-left: 17.00ex;">
						<i class="mdoc-farg">prefix</i> points outside the allocated address space.</dd>
				</dl>
			</div>
			<div class="mdoc-section">
				<h1> HISTORY</h1>
				The <b class="mdoc-name">hello</b> function call appeared in Foo OS version 1.0.
			</div>
		</div>
		<p>
			We can make sure the manual is complete by reviewing the checklist for function documenation.
		</p>
		<p>
			First we implied linking information by using category two (which does not need to be specially linked).  Then we
			introduced the calling syntax of the function, naming its arguments.  We also stipulated the necessary header files.  In
			the <span class="sec">DESCRIPTION</span>, we described the function and its arguments in full.  Lastly, we documented
			return values in the <span class="sec">RETURN VALUES</span> section and the errors set in <span
				class="sec">ERRORS</span>.
		</p>
		<p>
			We also added a <span class="sec">HISTORY</span> section, which isn't mentioned as part of our checklist but is
			considered good practise for system calls.  In general, a note on historical information is useful to put your component
			in the general context of related machinery.
		</p>
		<p class="nav">
			<a href="part2.xhtml">Next</a>
		</p>
		<p class="edits">
			Last edited by $Author$ on $Date$.  Copyright &copy; 2011, Kristaps Dzonsons.  CC BY-SA.
		</p>
	</body>
</html>
